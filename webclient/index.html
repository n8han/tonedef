<!DOCYTPE html>
<html>
  <head>
    <title>tonedef</title>
    <link href='http://fonts.googleapis.com/css?family=Corben:bold' rel='stylesheet' type='text/css'>
    <style type="text/css">
      * { margin:0; padding:0; }
      #container { width:400px; margin:0 auto; text-align:center; }
      #music ul li { float:left; }
      h1 { font-family: 'Corben', arial, serif; text-shadow: #ddd 4px 4px 4px; }
      .s {
          height:40px; width:40px; background:#ccc; margin:.25em;
          -webkit-border-radius: 10px;
          -moz-border-radius: 10px;
          border-radius: 10px;
      }
      ul { display:block; margin:.25em 0;}
      .on { background:#00FDFD; }
      .play { background:#FC00A0; }
      .clearfix:after {
          content: ".";
          display: block;
          height: 0;
          clear: both;
          visibility: hidden;
      }
    </style>
    <script type="text/javascript" src="jquery.min.js"></script>
  </head>
  <body>
    <div id="container">
      <h1>tonedef</h1>
      <div id="music">
      </div>
    </div>
    <div id="audio">
      <audio id="a">
        <source src="foo.mp3" type="audio/mpeg" />
      </audio>
    </div>
    <script type="text/javascript">
      var M = (function($, conf) {
          var conf = conf || {};
          conf['time'] = conf['time'] || 8;
          conf['host'] = conf['host'] || 'ws://localhost:8080';
          var T = {
              note: function(t, n) {
                  return ['<li class="n-'
                          , n
                          , ' s"></li>'].join('');
              },
              track: function(id) {
                  var n = conf['time'], buffer = [];
                  while(n--) buffer.push(T.note(id, n));
                  return ['<ul class="clearfix" id="t-'
                          , id
                          , '">'
                          , buffer.reverse().join('')
                          ,'</ul>'].join('');
              }
          };

          if(!document.createElement('audio').canPlayType) {
              alert("Audio is not supported in your browser. Try CHROME!");
          }
          var ws = null;

          var initTracks = function(sel, n) {
              var buff = [];
              while(n--) buff.push(T.track(n));
              $(sel).append(buff.reverse().join(''));
          }
          , idFromCls = function(jqel, re) {
              return parseInt(jqel.attr("class").split(' ').filter(function(c) {
                  return re.test(c); })[0].split('-')[1]);
          }
          , notify = function(jqel, play) {
              if(play) {
                  var aud = $("#a")[0];
                  aud.play();
                  var stop = function() { aud.stop(); };
                  setTimeout(stop,10);

              }
              var note = idFromCls(jqel, /n-(\d+)/)
              , tone = jqel.parent().attr("id").split("-")[1]
              , msg = {
                  music : {
                      tracks: {
                          '0': {
                              notes : { },
                              active: true
                          }
                      }
                  }
              };

              var i = conf['time']
              , tones = play ? [tone] : [];

              while(i--) {
                  var t = $(["#t-", i, " .n-", note].join(''));
                  if (t.hasClass('play') && i.toString() !== tone) {
                      tones.push(i.toString());
                  }
              }

              msg.music.tracks['0'].notes[note.toString()] =  {
                  'tones': tones,
                  'duration':1
              };

              if(ws != null) {
                  var payload = "foo:" + JSON.stringify(msg);
                  console.log("pushing " + payload);
                  ws.send(payload);
              }
          }
          , recieve = function(msg) {
              var notes = msg.music.tracks['0'].notes;
              for(n in notes) {
                  var tones = notes[n].tones || [];
                  // for each notes
                  $("#music .n-"+n).each(function(i, e) {
                      var jqel = $(e);
                      if(tones.filter(function(e) {
                          return e === jqel.parent().attr("id").split("-")[1];
                      }).length > 0) {
                          jqel.addClass("play");
                      } else jqel.removeClass("play");
                  });
              }
          };

          $(function(){

              initTracks("#music", 10);

              $("li").live('click', function() {
                  var e = $(this)
                  , play = e.hasClass("play");
                  // update UI here, if updating locally
                  notify(e, !play);
              });

              var n = 0
              var i = setInterval(function(){
                  n++;
                  $(".n-"+n).addClass("on");
                  $(":not(.n-"+n+")").removeClass("on");
                  if($(".n-"+n).hasClass("on")) $("#a")[0].play();
                  if(n > conf['time']) n = 0;
              }, 200);

              if(window.WebSocket) {
                  ws = new WebSocket(conf['host']);
                  ws.onopen = function(e) {
                      ws.send("foo:open");
                  };
                  ws.onmessage = function(e) {
                      console.log("recieving " + e.data);
                      recieve(JSON.parse(e.data));
                  };
                  ws.onclose = function(e) {

                  };
              } else {
                  alert("Web sockets not supported in your browser. Try CHROME!");
              }
          });
      })(jQuery, {
          'host': 'ws://10.11.254.241:8080'
      });
    </script>
  </body>
</html>